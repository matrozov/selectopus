!function(a){function b(b,c){var d={_items:{},_values:{},_languages:{},_options:{},_search:"",$element:!1,$root:!1,$placeholder:!1,$items:!1,$clear:!1,$popup:!1,$popupInput:!1,$popupItems:!1,$popupCreate:!1,$popupHint:!1,init:function(b,c){d.$element=b,d.$element.hide(),d._languages=a.fn.selectopus.languages,d._options=a.extend({},a.fn.selectopus.default,d.optionsPredefined(),c),d.create(),d.public.language=d._options.language,d.public.items=d._options.items,d.public.values=d._options.values,d.view.items.createList()},create:function(){d.$root=a("<div>").addClass("selectopus-root form-control").click(d.view.popup.onToggle).insertAfter(d.$element),d._options.multiple&&d.$root.addClass("selectopus-multiple"),d.$placeholder=a("<div>").addClass("selectopus-placeholder text-muted").appendTo(d.$root),d.$items=a("<div>").addClass("selectopus-items clearfix").appendTo(d.$root),d.$clear=a("<div>").addClass("selectopus-clear").html("&#x2716;").click(d.view.items.onClear).appendTo(d.$root),d._options.required&&d.$clear.hide(),d.$popup=a("<div>").addClass("selectopus-popup dropdown-menu"),d.$popupInput=a("<input>").attr("type","text").addClass("selectopus-popup-input form-control input-sm").keyup(d.view.popup.onSearch).appendTo(d.$popup),d._options.popupSearchBar||d.$popupInput.hide(),d.$popupItems=a("<ul>").addClass("selectopus-popup-items").appendTo(d.$popup),d.$popupCreate=a("<li>").addClass("selectopus-popup-item selectopus-popup-create").text("create new item").click(d.view.popup.items.onClick).appendTo(d.$popupItems),d.$popupHint=a("<div>").addClass("selectopus-popup-hint").appendTo(d.$popup),a(document).on("click",d.view.popup.onClose)},remove:function(){a(document).off("click",d.view.popup.onClose),d.$root.remove(),d.$element.removeData("selectopus")},optionsPredefined:function(){var c={items:{},values:[]},e=b.attr("lang");d.language.exists(e)?c.language=e:(e=a("html").attr("lang"),d.language.exists(e)&&(c.language=e));var f=["placeholder"];a.each(f,function(a,d){var e=b.attr(d);void 0!==e&&e.trim().length>0&&(c[d]=e)});var g=["required","multiple"];a.each(g,function(a,d){void 0!==b.attr(d)&&(c[d]=!0)});var h=["language","placeholder","url"];a.each(h,function(a,d){var e=b.data(d);void 0!==e&&e.trim().length>0&&(c[d]=e)});var i=["required","multiple","allowCreate","popupHideSelected","popupSearchBar","popupSearchHideItem","popupSearchMarkItem","popupCloseAfterSelect"];return a.each(i,function(a,d){var e=b.data(d);void 0!==e&&(c[d]="true"===e||"1"===e)}),d.$element.find("option").each(function(){var b=a(this),d=b.prop("value");void 0===d&&(d=b.text()),c.items[d]=b.text(),b.prop("selected")&&(c.multiple?c.values.push(d):c.values=[d])}),c},save:function(){d.$element.empty(),d.$element.attr("multiple",d._options.multiple),a.each(d._items,function(b,c){var e=d._options.onGetLabel(d.public,c);a("<option>").attr("selected",d.values.exists(b)).attr("value",b).text(e).appendTo(d.$element)}),a.each(d._values,function(b,c){if(!d.items.exists(b)){var e=d._options.onGetLabel(d.public,c);a("<option>").attr("selected",!0).attr("value",b).text(e).appendTo(d.$element)}})},language:{exists:function(a){return void 0!==d._languages[a]},translate:function(a){return d._languages[d._options.language][a]},set:function(a){d.language.exists(a)&&(d._options.language=a,d.language.reload())},reload:function(){d.$popupInput.attr("placeholder",d.language.translate("popupSearchPlaceholder"));var a=d._options.placeholder;a||(a=d.language.translate("placeholder")),d.$placeholder.text(a)}},items:{load:function(a){d._options.onLoad(d.public,d._search,function(b){d._items=b,a()})},add:function(a,b){d._options.items[a]=b,d._items[a]=b},exists:function(a){return void 0!==d._items[a]},get:function(b){if(d.items.exists(b))return a.isPlainObject(d._items[b])?jQuery.extend({},d._items[b]):d._items[b]}},values:{keys:function(){var b=[];return a.each(d._values,function(a){b.push(a)}),b},exists:function(a){return void 0!==d._values[a]},addList:function(b){a.isArray(b)?a.each(b,function(a,b){d.values.add(b)}):a.each(b,function(a,b){d.values.add(a,b)})},add:function(a,b){d._values[a]=void 0!==b?b:d.items.exists(a)?d.items.get(a):d.values.get(a),d.$element.trigger("selectopus-select",a),d.$element.trigger("selectopus-change"),d.$element.trigger("change")},remove:function(a){delete d._values[a],d.$element.trigger("selectopus-unselect",a),d.$element.trigger("selectopus-change"),d.$element.trigger("change")},get:function(b){if(d.values.exists(b))return a.isPlainObject(d._values[b])?jQuery.extend({},d._values[b]):d._values[b]},clear:function(){d._values={}}},view:{items:{createList:function(){d.view.items.clear(),a.isEmptyObject(d._values)?(d.$placeholder.show(),d.$clear.hide()):(d.$placeholder.hide(),d._options.required||d.$clear.show()),a.each(d._values,function(a){d.view.items.create(a)})},create:function(b){var c=d.values.get(b);a("<span>").addClass("selectopus-item").html(d._options.onRenderItem(d.public,b,d._options.onGetLabel(d.public,c),c)).data("value",b).click(d.view.items.onClick).appendTo(d.$items)},clear:function(){d.$items.empty()},onClear:function(){return d.values.clear(),d.view.items.createList(),d.view.popup.close(),!1},onClick:function(){if(!d._options.multiple)return!0;var b=a(this).data("value");return d.values.exists(b)&&(d.values.remove(b),d.save(),d.view.items.createList()),d.view.popup.close(),!1}},popup:{items:{createList:function(){d.view.popup.items.clear(),d._items=d._options.onSearch(d.public,d._search);var b={};a.each(d._items,function(a,c){d.values.exists(a)&&d._options.popupHideSelected||(b[a]=c)}),a.each(b,function(a){d.view.popup.items.create(a,d._search)}),a.isEmptyObject(b)?(d._search.length>0?d.$popupHint.text(d.language.translate("popupSearchNotFound")):d.$popupHint.text(d.language.translate("popupEmpty")),d.$popupHint.css("display","block")):d.$popupHint.css("display","none")},create:function(b){var c=d.items.get(b),e=d._options.onGetLabel(d.public,c);d._options.popupSearchMarkItem&&(e=d.public.utils.mark(e,d._search));var f=d._options.onRenderPopupItem(d.public,b,e,c),g=a("<li>").addClass("selectopus-popup-item").html(f).data("value",b).click(d.view.popup.items.onClick).appendTo(d.$popupItems);d.values.exists(b)&&g.addClass("selectopus-popup-item-selected")},clear:function(){d.$popupItems.find(".selectopus-popup-item:not(.selectopus-popup-create)").remove()},onClick:function(){var b=a(this).data("value");return a(this).is(".selectopus-popup-create")&&d.items.add(b,d._options.onCreateItem(d.public,b)),d._options.multiple?d.values.exists(b)?(d.values.remove(b),d.save()):(d.values.add(b),d.save()):d.values.exists(b)?d._options.required||(d.values.remove(b),d.save()):(d.values.clear(),d.values.add(b),d.save()),d._options.popupCloseAfterSelect?d.view.popup.close():d.view.popup.items.createList(),d.view.items.createList(),!1}},get isOpened(){return d.$popup.is(":visible")},toggle:function(){d.view.popup.isOpened?d.view.popup.close():d.view.popup.open()},open:function(){a(document).trigger("click"),d.items.load(function(){d.view.popup.items.createList();var b=d.$root[0].getBoundingClientRect(),c=a(document);d.$popup.css("width",b.width),d.$popup.css("left",b.left+c.scrollLeft()),d.$popup.css("top",b.bottom+c.scrollTop()),d.$popup.appendTo("body"),d.$popupItems.scrollTop(0),d.$popupInput.val("").focus(),d.$popupCreate.hide()})},close:function(){d.view.popup.isOpened&&(d.$popup.detach(),d.view.popup.items.clear(),d._search="")},onToggle:function(){return d.view.popup.toggle(),!1},onOpen:function(){return d.view.popup.open(),!1},onClose:function(b){if(!d.view.popup.isOpened)return!0;var c=a(b.target);if(c[0]===d.$popup[0])return!0;var e=c.parents(".selectopus-popup:first");return e.length>0&&e[0]===d.$popup[0]||(d.view.popup.close(),!1)},onSearch:function(){if(d._search=d.$popupInput.val().trim(),d.items.load(function(){d._search.length,d.view.popup.items.createList()}),d._options.allowCreate&&d._search.length>0){var a=d._options.onCreateItem(d.public,d._search),b=d._options.onGetLabel(d.public,a);d._options.popupSearchMarkItem&&(b=d.public.utils.mark(b,d._search)),d.$popupCreate.data("value",d._search).html(d._options.onRenderPopupItem(d.public,d._search,b,a)),d.$popupCreate.show()}else d.$popupCreate.hide()}}},public:{get options(){return d._options},get language(){return d._options.language},set language(a){d.language.set(a)},get items(){return d._items},set items(a){d._options.items=a,d._items=a},get values(){return d.values.keys()},set values(a){d.values.clear(),d.values.addList(a),d.save(),d.view.items.createList()},popup:{get isOpened(){return d.view.popup.isOpened},toggle:function(){d.view.popup.toggle()},open:function(){d.view.popup.open()},close:function(){d.view.popup.close()}},remove:function(){d.remove()},utils:{match:function(a,b){if("string"!=typeof a||"string"!=typeof b||0===b.trim().length)return a;var c=new RegExp(b.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&"),"gi");return a.match(c)},mark:function(a,b){if("string"!=typeof a||"string"!=typeof b||0===b.trim().length)return a;var c=new RegExp(b.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&"),"gi");return a.replace(c,function(a){return"<mark>"+a+"</mark>"})}}}};return d.init(b,c),d.public}a.fn.selectopus=function(c){return this.each(function(){var d=a(this),e=d.data("selectopus");return void 0===e&&(e=new b(d,c),d.data("selectopus",e)),e}).data("selectopus")},a.fn.selectopus.default={items:{},values:[],language:"en",placeholder:!1,required:!1,multiple:!1,allowCreate:!1,popupHideSelected:!1,popupSearchBar:!0,popupSearchHideItem:!0,popupSearchMarkItem:!0,popupCloseAfterSelect:!0,url:!1,onLoad:function(b,c,d){if(!b.options.url)return void d(b.options.items);try{a.getJSON(b.options.url+c,function(b){if(!a.isPlainObject(b))return void d({});d(b)})}catch(a){d({})}},onSearch:function(b,c){if(!b.options.popupSearchHideItem||void 0===c||0===c.trim().length)return b.items;var d={};return a.each(b.items,function(a,e){b.utils.match(b.options.onGetLabel(b,e),c)&&(d[a]=e)}),d},onGetLabel:function(a,b){return b},onRenderItem:function(a,b,c,d){return c},onRenderPopupItem:function(a,b,c,d){return c},onCreateItem:function(a,b){return b}},a("body").ready(function(){a(".selectopus").selectopus()}),a.fn.selectopus.languages={}}(jQuery),function(a){a.fn.selectopus.languages.en={placeholder:"Click here to select items...",popupEmpty:"Empty list!",popupSearchPlaceholder:"Start type for search items...",popupSearchNotFound:"No results found!"}}(jQuery),function(a){a.fn.selectopus.languages.ru={placeholder:"Нажмите, что бы выбрать элементы...",popupEmpty:"Список пуст!",popupSearchPlaceholder:"Начните писать, что бы найти элементы...",popupSearchNotFound:"Совпадений не найдено!"}}(jQuery);