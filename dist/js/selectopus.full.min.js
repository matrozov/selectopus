!function(a){function b(b,c){var d={_items:{},_value:{},_languages:{},_options:{},_search:"",$element:!1,$root:!1,$items:!1,$popup:!1,$popupInput:!1,$popupItems:!1,$popupHint:!1,init:function(b,c){d.$element=b,d.$element.hide(),d._languages=a.fn.selectopus.languages,d._options=a.extend({},a.fn.selectopus.default,d.optionsPredefined(),c),d.create(),d.public.language=d._options.language,d.public.items=d._options.items,d.public.value=d._options.value,d.view.items.createList()},create:function(){d.$root=a("<div>").addClass("selectopus-root form-control").click(d.view.popup.onToggle).insertAfter(d.$element),d._options.multiple&&d.$root.addClass("selectopus-multiple"),d.$items=a("<div>").addClass("selectopus-items clearfix").appendTo(d.$root),d.$popup=a("<div>").addClass("selectopus-popup").appendTo("body"),d.$popupInput=a("<input>").attr("type","text").addClass("selectopus-popup-input form-control input-sm").keyup(d.view.popup.onSearch).appendTo(d.$popup),d.$popupItems=a("<ul>").addClass("selectopus-popup-items").appendTo(d.$popup),d.$popupHint=a("<div>").addClass("selectopus-popup-hint").appendTo(d.$popup),a(document).click(d.view.popup.onClose)},optionsPredefined:function(){var c={items:{},value:[],multiple:d.$element.is("[multiple]")};d.$element.find("option").each(function(){var b=a(this),d=b.prop("value");c.items[d]=b.text(),b.prop("selected")&&(c.multiple?c.value.push(d):c.value=d)});var e=b.attr("lang");d.language.exists(e)?c.language=e:(e=a("html").attr("lang"),d.language.exists(e)&&(c.language=e));var f=["language","url"];a.each(f,function(a,d){var e=b.data(d);void 0!==e&&e.trim().length>0&&(c[d]=e)});var g=["multiple","popupHideSelected","popupSearchHide","popupSearchHighlight","popupCloseAfterSelect"];return a.each(g,function(a,d){var e=b.data(d);void 0!==e&&(c[d]="true"===e||"1"===e)}),c},language:{exists:function(a){return void 0!==d._languages[a]},translate:function(a){return d._languages[d._options.language][a]},set:function(a){d.language.exists(a)&&(d._options.language=a,d.language.reload())},reload:function(){d.$popupInput.attr("placeholder",d.language.translate("popupSearchPlaceholder"))}},items:{load:function(a){d._options.onLoad(d.public,d._search,function(b){d._items=b,a()})},exists:function(a){return void 0!==d._items[a]},get:function(a){if(d.items.exists(a))return d._items[a]}},value:{keys:function(){var b=[];return a.each(d._value,function(a,c){b.push(a)}),b},exists:function(a){return void 0!==d._value[a]},save:function(){d.$element.empty(),a.each(d._value,function(b,c){a("<option>").attr("selected",!0).text(c).appendTo(d.$element)})},addList:function(b){a.each(b,function(a,b){d.value.add(b)})},add:function(a){d._value[a]=d.items.exists(a)?d.items.get(a):d.value.get(a),d.$element.trigger("selectopus-select",a),d.$element.trigger("selectopus-change"),d.$element.trigger("change")},remove:function(a){delete d._value[a],d.$element.trigger("selectopus-unselect",a),d.$element.trigger("selectopus-change"),d.$element.trigger("change")},get:function(a){if(d.value.exists(a))return d._value[a]},clear:function(){d._value={}}},view:{items:{createList:function(){d.view.items.clear(),a.each(d._value,function(a){d.view.items.create(a)})},create:function(b){a("<span>").addClass("selectopus-item").html(d._options.onRenderItem(d.public,b,d.value.get(b))).data("value",b).click(d.view.items.onClick).appendTo(d.$items)},clear:function(){d.$items.empty()},onClick:function(){if(!d._options.multiple)return!0;var b=a(this).data("value");return d.value.exists(b)&&(d.value.remove(b),d.value.save(),d.view.items.createList()),d.view.popup.close(),!1}},popup:{items:{createList:function(){d.view.popup.items.clear(),d._items=d._options.onSearch(d.public,d._search);var b={};a.each(d._items,function(a,c){d.value.exists(a)&&d._options.popupHideSelected||(b[a]=c)}),a.each(b,function(a){d.view.popup.items.create(a,d._search)}),a.isEmptyObject(b)?(d._search.length>0?d.$popupHint.text(d.language.translate("popupSearchNotFound")):d.$popupHint.text(d.language.translate("popupEmpty")),d.$popupHint.show()):d.$popupHint.hide()},create:function(b){var c=d._options.onRenderPopupItem(d.public,b,d.items.get(b),d._search),e=a("<li>").addClass("selectopus-popup-item").html(c).data("value",b).click(d.view.popup.items.onClick).appendTo(d.$popupItems);d.value.exists(b)&&e.addClass("selectopus-popup-item-selected")},clear:function(){d.$popupItems.empty()},onClick:function(){var b=a(this).data("value");return d._options.multiple&&d.value.exists(b)?(d.value.remove(b),d.value.save()):(d._options.multiple||d.value.clear(),d.value.add(b),d.value.save()),d._options.popupCloseAfterSelect?d.view.popup.close():d.view.popup.items.createList(),d.view.items.createList(),!1}},get isOpened(){return d.$popup.is(":visible")},toggle:function(){d.view.popup.isOpened?d.view.popup.close():d.view.popup.open()},open:function(){a(document).trigger("click"),d.items.load(function(){d.view.popup.items.createList();var b=d.$root[0].getBoundingClientRect();d.$popup.css("width",b.width),d.$popup.css("left",b.left+a("body").scrollLeft()),d.$popup.css("top",b.bottom+a("body").scrollTop()),d.$popup.show(),d.$popupItems.scrollTop(0),d.$popupInput.val("").focus()})},close:function(){d.view.popup.isOpened&&(d.$popup.hide(),d.view.popup.items.clear(),d._search="")},onToggle:function(){return d.view.popup.toggle(),!1},onOpen:function(){return d.view.popup.open(),!1},onClose:function(b){if(!d.view.popup.isOpened)return!0;var c=a(b.target);if(c[0]===d.$popup[0])return!0;var e=c.parents(".selectopus-popup:first");return e.length>0&&e[0]===d.$popup[0]||(d.view.popup.close(),!1)},onSearch:function(){d._search=d.$popupInput.val().trim(),d.items.load(function(){d._search.length,d.view.popup.items.createList()})}}},public:{get options(){return d._options},get language(){return d._options.language},set language(a){d.language.set(a)},get items(){return d._items},set items(a){d._options.items=a,d._items=a},get value(){return d._options.multiple?d.value:d.value[0]},set value(b){d._options.multiple?a.isArray(b)&&(d.value.clear(),d.value.addList(b)):d.value.addList([b]),d.value.save(),d.view.items.createList()},popup:{get isOpened(){return d.view.popup.isOpened},toggle:function(){d.view.popup.toggle()},open:function(){d.view.popup.open()},close:function(){d.view.popup.close()}},utils:{match:function(a,b){if("string"!=typeof a||"string"!=typeof b||0===b.trim().length)return a;var c=new RegExp(b.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&"),"gi");return a.match(c)},markup:function(a,b){if("string"!=typeof a||"string"!=typeof b||0===b.trim().length)return a;var c=new RegExp(b.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&"),"gi");return a.replace(c,function(a){return"<mark>"+a+"</mark>"})}}}};return d.init(b,c),d.public}a.fn.selectopus=function(c){return this.each(function(){var d=a(this),e=d.data("selectopus");return void 0===e&&(e=new b(d,c),d.data("selectopus",e)),e}).data("selectopus")},a.fn.selectopus.default={items:{},value:[],language:"en",multiple:!1,popupHideSelected:!1,popupSearchHide:!0,popupSearchHighlight:!0,popupCloseAfterSelect:!0,url:!1,onLoad:function(b,c,d){if(!b.options.url)return void d(b.options.items);try{a.getJSON(b.options.url+c,function(b){if(!a.isPlainObject(b))return void d({});d(b)})}catch(a){d({})}},onSearch:function(b,c){if(!b.options.popupSearchHide||void 0===c||0===c.trim().length)return b.items;var d={};return a.each(b.items,function(a,e){b.utils.match(e,c)&&(d[a]=e)}),d},onRenderItem:function(a,b,c){return c},onRenderPopupItem:function(a,b,c,d){return a.options.popupSearchHighlight&&(c=a.utils.markup(c,d)),c}},a("body").ready(function(){a(".selectopus").selectopus()}),a.fn.selectopus.languages={}}(jQuery),function(a){a.fn.selectopus.languages.en={popupEmpty:"Empty list!",popupSearchPlaceholder:"Start type for search items...",popupSearchNotFound:"No results found!"}}(jQuery),function(a){a.fn.selectopus.languages.ru={popupEmpty:"Список пуст!",popupSearchPlaceholder:"Начните писать, что бы найти элементы...",popupSearchNotFound:"Совпадений не найдено!"}}(jQuery);